pool:
    name: ads-build-1es-hosted-pool
    demands: 
    - ImageOverride -equals ADS-Linux_Image

steps:

  - task: DockerInstaller@0
    displayName: Docker Installer
    inputs:
      secureFile: 'testsettings.json'
      dockerVersion: 17.09.0-ce
      releaseType: stable

  - script: docker pull mcr.microsoft.com/mssql/server:2019-latest
    displayName: Pull MSSQL Docker Image  

  - script: 'docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=$(sql-server-password)"
    -e "MSSQL_AGENT_ENABLED=True"
    -p 1433:1433 --name sql1 -h sql1
    -d mcr.microsoft.com/mssql/server:2019-latest'
    displayName: Start Server in Docker Container

  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk '
    inputs:
      useGlobalJson: true

  - task: ShellScript@2
    displayName: Creating expected directories by dotnet build
    inputs:
      scriptPath: ./azure-pipelines/createBuildDirectories.sh
      cwd: ../

  - task: NuGetAuthenticate@0

  - task: DotNetCoreCLI@2
    displayName: 'Building test environment'
    inputs:
      projects: '**/Microsoft.SqlTools.ServiceLayer.TestEnvConfig.csproj'

  - task: DownloadSecureFile@1
    displayName: 'Download Test Environment Configuration'
    name: testEnvironmentPath
    inputs:
      secureFile: 'SQLConnectionInstances.xml'

  - task: DotNetCoreCLI@2
    displayName: 'Setting up test environment'
    inputs:
      command: run
      projects: '**/Microsoft.SqlTools.ServiceLayer.TestEnvConfig.csproj'
      arguments: $(testEnvironmentPath.secureFilePath)
      testRunTitle: 'Setting tests'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet build'
    inputs:
      projects: '**/Microsoft.SqlTools.ServiceLayer.IntegrationTests.csproj'
      arguments: '/p:CodeCoverageBuild=true'

  - task: DotNetCoreCLI@2
    displayName: 'Run integration tests'
    inputs:
      command: test
      projects: '**/Microsoft.SqlTools.ServiceLayer.IntegrationTests.csproj'
      arguments: '--no-build'
      testRunTitle: 'SqlToolsService Integration Tests'
