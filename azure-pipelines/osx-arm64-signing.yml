steps:
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      downloadType: specific
      itemPattern: 'drop/Microsoft.SqlTools.ServiceLayer-osx-arm64-unsigned-net7.0.tar.gz'
      downloadPath: '$(Agent.TempDirectory)'

  - script: |
      cd $(Agent.TempDirectory)/drop
      tar -xzvf Microsoft.SqlTools.ServiceLayer-osx-arm64-unsigned-net7.0.tar.gz -C sts
    displayName: 'Extract the files'

  - script: |
      cd $(Agent.TempDirectory)/drop
      mkdir sts
      cd sts
      codesign -s - MicrosoftSqlToolsCredentials
      codesign -s - MicrosoftSqlToolsServiceLayer
      codesign -s - SqlToolsResourceProviderService
    displayName: 'Sign the executables'

  - script: |
      cd $(Agent.TempDirectory)/drop/sts
      tar -czvf Microsoft.SqlTools.ServiceLayer-osx-arm64-net7.0.tar.gz *
    displayName: 'Archive the files'

  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: '$(Agent.TempDirectory)/drop/sts'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
      Contents: 'Microsoft.SqlTools.ServiceLayer-osx-arm64-net7.0.tar.gz'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'